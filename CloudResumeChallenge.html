293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
<!DOCTYPE html>
      listEl.innerHTML = '';
      data.slice(0,5).forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `${getFlagEmoji(item.country)} <strong>${item.city}, ${item.region}</strong> — ${getISPIcon(item.org)} <em>${item.org || ''}</em>`;
        listEl.appendChild(li);
      });
    }

    function renderMap(data){
      const map = L.map('map').setView([20,0], 2);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '© CARTO & © OpenStreetMap contributors', maxZoom: 18
      }).addTo(map);

      if(!data.length){ return; }

      const markers = L.markerClusterGroup();
      const heatData = [];
      data.forEach(v => {
        const latlng = [v.lat, v.lng];
        markers.addLayer(L.marker(latlng).bindPopup(`<strong>${v.city}</strong><br>${v.org}<br>${v.timestamp}`));
        heatData.push([...latlng, 0.5]);
      });
      map.addLayer(markers);
      L.heatLayer(heatData, { radius: 25 }).addTo(map);
      map.fitBounds(L.latLngBounds(data.map(d => [d.lat, d.lng])), { padding: [50,50] });
    }

    function renderAll(raw){
      const data = normalizeData(raw).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
      revealDynamic();
      document.getElementById('visit-count').textContent = `Visits: ${data.length}`;
      renderList(data);
      renderMap(data);
    }

    function showDemoBadge(){
      const badge = document.getElementById('demo-badge');
      if(badge){ badge.classList.remove('js-hidden'); badge.setAttribute('aria-hidden','false'); }
    }

    async function bootstrap(){
      try{
        const data = await Promise.race([ safeFetchJson(API_URL, { timeout: FETCH_TIMEOUT_MS }), timeout(FETCH_TIMEOUT_MS + 1000) ]);
        renderAll(data);
      } catch(err){
        console.warn('[ReadGeoCoords] falling back to mock data:', err?.message || err);
        renderAll(MOCK_TYPICAL);
        showDemoBadge();
      }
      if(TEST_MODE){ runTests(); }
    }

    // ===== Simple test harness (enable with ?test=1) =====
    function assert(name, cond){
      const el = document.getElementById('test-results');
      el.classList.remove('js-hidden');
      const line = document.createElement('div');
      line.textContent = (cond ? '✅ ' : '❌ ') + name;
      el.appendChild(line);
      if(!cond) console.error('[TEST FAIL]', name);
    }

    function runTests(){
      // 1) normalize typical
      const n1 = normalizeData(MOCK_TYPICAL);
      assert('normalizeData returns same length for valid items', n1.length === MOCK_TYPICAL.length);
      // 2) normalize malformed
      const n2 = normalizeData(MOCK_MALFORMED);
      assert('normalizeData filters invalid items', n2.length === 0);
      // 3) fallback render does not crash on empty
      try { renderAll(MOCK_EMPTY); assert('renderAll handles empty dataset', true); } catch(e){ assert('renderAll handles empty dataset', false); }
      // 4) emoji
      assert('getFlagEmoji for US returns string', typeof getFlagEmoji('US') === 'string' && getFlagEmoji('US').length > 0);
    }

    window.addEventListener('DOMContentLoaded', bootstrap);
  </script>
</body>
</html>
