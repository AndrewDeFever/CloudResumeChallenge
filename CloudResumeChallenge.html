<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Andrew DeFever | Cloud Resume</title>

  <!-- Your existing styles -->
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 2rem;
      background-color: #f9f9f9;
      color: #333;
    }
    header {
      text-align: center;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.2rem;
    }
    h2 {
      margin-top: 2rem;
    }
    a {
      color: #007acc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .section {
      margin-bottom: 1.5rem;
    }
    ul {
      padding-left: 1.2rem;
    }
    .badges img {
      height: 80px;
      margin-right: 1rem;
    }
    .cert-download {
      margin-top: 1rem;
    }
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600&display=swap');
    h1, h2 { font-family: 'Orbitron', sans-serif; }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .section { animation: fadeInUp 0.6s ease-out; }

    /* Map & legend styling */
    #map { height: 500px; margin: 1rem 0; border: 1px solid #ccc; }
    .legend {
      position: absolute;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 6px 10px;
      font-size: 0.9rem;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 6px;
      vertical-align: middle;
    }
  </style>

  <!-- Font Awesome (for Visitor Log icons) -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- 1) Leaflet core CSS/JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- 2) MarkerCluster plugin -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- 3) Heatmap plugin -->
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
</head>

<body>
  <nav style="text-align:center; margin-bottom: 2rem; font-weight: bold;">
    <a href="#about">About</a> |
    <a href="#certs">Certifications</a> |
    <a href="#skills">Skills</a> |
    <a href="#projects">Projects</a> |
    <a href="#experience">Experience</a> |
    <a href="#education">Education</a>
  </nav>

  <header>
    <h1>Andrew DeFever</h1>
    <p>AWS Certified | Cloud Resume Challenge</p>
    <p>
      <a href="mailto:AndrewDeFever@gmail.com">AndrewDeFever@gmail.com</a> |
      <a href="https://github.com/AndrewDeFever" target="_blank">GitHub</a> |
      <a href="https://www.linkedin.com/in/andrewdefever/" target="_blank">LinkedIn</a>
    </p>
  </header>

  <section class="section" id="about">
    <h2>About This Site</h2>
    <ul>
      <li>Hosted on Amazon S3 with static website hosting</li>
      <li>Delivered through CloudFront (CDN)</li>
      <li>Integrated with API Gateway and Lambda (Python) to log IP address</li>
      <li>Stores logs in DynamoDB</li>
    </ul>
    <p><a href="https://github.com/AndrewDeFever/CloudResumeChallenge" target="_blank">View the GitHub repository</a></p>
  </section>

  <!-- (Other sections: certs, skills, projects, experience, education, download) -->

  <section class="section cert-download">
    <h2>Download Resume</h2>
    <p><a href="./CloudResumeChallenge/Andrew-DeFever-Resume-2025-AWS.docx" download>Download as Word Document</a></p>
  </section>

  <!-- GeoTracker POST (logs visit) -->
  <script>
    fetch("https://njx3tbb522.execute-api.us-east-1.amazonaws.com/track", {
      method: "POST"
    });
  </script>

  <!-- Visits count & map container -->
  <p id="visit-count">Visits: loading...</p>
  <h2>Visitor Map</h2>
  <div id="map"></div>

  <!-- Visitor Log -->
  <section class="section" id="visitor-log">
    <h2>Recent Visitors</h2>
    <ul id="visitor-list"></ul>
  </section>

  <!-- Main map + clustering + heat + legend script -->
<script>
  // â”€â”€â”€ Global Canvas2D patch: add willReadFrequently to every 2d context â”€â”€â”€
  (function() {
    const origGetCtx = HTMLCanvasElement.prototype.getContext;
    HTMLCanvasElement.prototype.getContext = function(type, options) {
      if (type === '2d') {
        // Always request willReadFrequently for Canvas2D
        return origGetCtx.call(this, '2d', { willReadFrequently: true });
      }
      // Other contexts (webgl, etc.) unchanged
      return origGetCtx.call(this, type, options);
    };
  })();

  const API_URL = "https://lkqaj47w3b.execute-api.us-east-1.amazonaws.com/ReadGeoCoords";

  // Utility: country flag emoji
  function getFlagEmoji(cc) {
    if (!cc) return "ðŸŒ";
    return [...cc.toUpperCase()]
      .map(c => String.fromCodePoint(127397 + c.charCodeAt()))
      .join("");
  }

  // Utility: ISP icons
  const ispIconMap = {
    "Google": "fab fa-google",
    "Cox":    "fas fa-globe-americas",
    // â€¦add your mappingsâ€¦
  };
  function getISPIcon(org = "") {
    const match = Object.keys(ispIconMap).find(k => org.includes(k));
    return match ? `<i class="${ispIconMap[match]}"></i>` : '<i class="fas fa-globe"></i>';
  }

  fetch(API_URL)
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data)) {
        console.error("Expected array, got:", data);
        document.getElementById("visit-count").textContent = "Visits: unavailable";
        return;
      }

      // Update visit count
      document.getElementById("visit-count").textContent = `Visits: ${data.length}`;

      // Sort by latest timestamp
      data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      // Populate Recent Visitors (top 5)
      const listEl = document.getElementById("visitor-list");
      listEl.innerHTML = "";
      data.slice(0, 5).forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `
          ${getFlagEmoji(item.country)} 
          <strong>${item.city}, ${item.region}</strong> â€”
          ${getISPIcon(item.org)} <em>${item.org}</em>
        `;
        listEl.appendChild(li);
      });

      // 1) Initialize map & Carto Light tiles
      const map = L.map("map").setView([20, 0], 2);
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
          attribution: 'Â© CARTO & Â© OpenStreetMap contributors',
          maxZoom: 18
        }
      ).addTo(map);

      // Prepare clustering & heatmap data
      const markers = L.markerClusterGroup();
      const heatData = [];
      data.forEach(v => {
        const latlng = [v.lat, v.lng];
        markers.addLayer(
          L.marker(latlng)
            .bindPopup(`<strong>${v.city}</strong><br>${v.org}<br>${v.timestamp}`)
        );
        heatData.push([...latlng, 0.5]);
      });
      map.addLayer(markers);

      // 3) Add heat overlay
      L.heatLayer(heatData, { radius: 25 }).addTo(map);

      // 1) Auto-zoom to fit all markers
      map.fitBounds(
        L.latLngBounds(data.map(d => [d.lat, d.lng])),
        { padding: [50, 50] }
      );

      // 4) Add on-map legend
      const legend = L.control({ position: 'bottomright' });
      legend.onAdd = () => {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
          <strong>Legend</strong><br>
          <span style="background:#3388ff;border-radius:50%;"></span> Visitors<br>
          <span style="background:rgba(255,0,0,0.5);"></span> Heat intensity
        `;
        return div;
      };
      legend.addTo(map);
    })
    .catch(err => {
      console.error("ReadGeoCoords error:", err);
      document.getElementById("visit-count").textContent = "Visits: unavailable";
    });
</script>
</body>
</html>
